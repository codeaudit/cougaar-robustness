####################################################
# Rule to insert components required for
# Adaptive Robustness Use-Case 1(ARUC1) defense
####################################################

# OBJS Sensor components
sensor_domain       = "org.cougaar.tools.robustness.sensors.SensorDomain"
ping_server         = "org.cougaar.tools.robustness.sensors.PingServerPlugin"
hb_server           = "org.cougaar.tools.robustness.sensors.HeartbeatServerPlugin"
hb_requester        = "org.cougaar.tools.robustness.sensors.HeartbeatRequesterPlugin"
ping_requester      = "org.cougaar.tools.robustness.sensors.PingRequesterPlugin"

# OBJS Deconfliction components
omsp                = "org.cougaar.core.adaptivity.OperatingModeServiceProvider"
ompm                = "org.cougaar.core.adaptivity.OperatingModePolicyManager"
csp                 = "org.cougaar.core.adaptivity.ConditionServiceProvider"
co                  = "org.cougaar.tools.robustness.deconfliction.CoordinatorPlugin"

# OBJS Coordinator required stuff
ltsp = "org.cougaar.coordinator.techspec.xml.LoadTechSpecsPlugin"
techspecs = ['Restart_LivenessSensor.xml',
             'Restart_RestartActuator.xml',
             'Restart_AgentAssetStateDimensions.xml',
             'Restart_Events.xml',
             'Restart_HostAssetStateDimensions.xml',
             'Restart_NodeAssetStateDimensions.xml',
             'Restart_RestartActuator.xml',
             'Restart_Threats.xml']

# MIC UC1 components
ar_servlet          = "org.cougaar.tools.robustness.ma.ui.ARServlet"
node_health_monitor = "org.cougaar.tools.robustness.ma.plugins.NodeHealthMonitorPlugin"

# Boeing components
load_balancer  	    ="org.cougaar.robustness.exnihilo.plugin.EN4JPlugin"

managerPluginsToAdd = [hb_requester, ping_requester, node_health_monitor, ar_servlet, load_balancer, omsp, ompm, csp, co]
agentPluginsToAdd   = [hb_server, ping_server]
nodePluginsToAdd    = [hb_requester, ping_requester, ping_server, node_health_monitor, ar_servlet]

# Add components to all Agents
society.each_agent do |agent|
  agent.add_components(agentPluginsToAdd)
  # Add components to robustness manager agents
  if agent.name =~ /.*ARManager.*/
    agent.add_components(managerPluginsToAdd)
    found = false
    agent.each_component do |c|
      next unless c.classname = ltsp
      techspecs.each do |ts|
        c.add_argument(ts) unless c.has_argument?(ts)
      end
      c.name = c.comparison_name
      found = true
      break
    end
    unless found
      agent.add_component do |c|
        c.classname = ltsp
        c.insertionpoint = 'Node.AgentManager.Agent.PluginManager.Plugin'
        techspecs.each do |ts|
          c.add_argument(ts)
        end
      end
    end
  end
  agent.add_component do |c|
    c.name = agent.name + "|" + sensor_domain
    c.classname = sensor_domain
    c.priority = "COMPONENT"
    c.insertionpoint = "Node.AgentManager.Agent.DomainManager.Domain"
    c.add_argument("sensors")
  end
end

# Add components to Nodes
society.each_node_agent do |node_agent|
  node_agent.add_components(nodePluginsToAdd)
  found = false
  node_agent.each_component do |c|
    next unless c.classname = ltsp
    techspecs.each do |ts|
      c.add_argument(ts) unless c.has_argument?(ts)
    end
    c.name = c.comparison_name
    found = true
    break
  end
  unless found
    node_agent.add_component do |c|
      c.classname = ltsp
      c.insertionpoint = 'Node.AgentManager.Agent.PluginManager.Plugin'
      techspecs.each do |ts|
        c.add_argument(ts)
      end
    end
  end
  node_agent.add_component do |c|
    c.name = node_agent.name + "|" + sensor_domain
    c.classname = sensor_domain
    c.priority = "COMPONENT"
    c.insertionpoint = "Node.AgentManager.Agent.DomainManager.Domain"
    c.add_argument("sensors")
  end
end

society.each_node do |node|
  node.override_parameter("-Dorg.cougaar.robustness.exnihilo.plugin.COLLECT_MESSAGE_TRAFFIC", "false")
  node.append_value_on_parameter("-Dorg.cougaar.config.path", "$COUGAAR_INSTALL_PATH/configs/coordinator/Sledgehammer")
  node.override_parameter("-Dorg.cougaar.tools.robustness.minHostsForMgrRestart", "2")
end
